@page "/customer"

@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization;
@using MudBlazor
@using Newtonsoft.Json
@using OrderDeliverySystem.Share.DTOs
@using OrderDeliverySystem.Client.Shared.Common
@using System.Security.Claims
@using OrderDeliverySystem.Client.Infrastructure.Services.Profile
@using System.Text.Json
@inject IHttpClientFactory httpClientFactory
@inject NavigationManager NavigationManager
@inject IProfileService ProfileService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ILogger<CustomerProfile> logger
@inject IJSRuntime JSRuntime
@rendermode InteractiveAuto
<br><br /><br /><br />
@if (isLoading)
{
    <p>Loading profile...</p>
}
else if (model != null)
{

<MudContainer>
        <div Style="display:none;">
            <MudField id="userId" Text="@model.UserId" />
        </div>
    <MudGrid>
        <MudGrid>
            <MudItem xs="2">
                    <MudField Label="Firstname:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.FirstName</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Lastname:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.LastName</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Email:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.Email</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Phone:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.Phone</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Unit:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.Unit</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Address:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText>@model.Address</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="City:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText >@model.City</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Province:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText>@model.Province</MudText>
                </MudField>
            </MudItem>
            <MudItem xs="2">
            </MudItem>

            <MudItem xs="2">
                <MudField Label="Postcode:" AlignLabel="Align.Start" Underline="false" />
            </MudItem>
            <MudItem xs="8">
                    <MudField Underline="false" Margin="Margin.None" Style="margin-top: 16px;">
                        <MudText>@model.Postcode</MudText>
                </MudField>
            </MudItem>
        </MudGrid>
        <MudItem xs="2">
        </MudItem>

    </MudGrid>
</MudContainer>
}
@code {
    private UserProfileDTO model = new(); // Ensure model is initialized

    public bool ShowErrors { get; set; } = false;
    public IEnumerable<string> Errors { get; set; } = new List<string>();

    private string userId = "5";
    private bool isLoading = true;

    private async Task LoadUserProfile()
    {
        try
        {
            var httpClient = httpClientFactory.CreateClient("API");
            httpClient.DefaultRequestHeaders.Add("Accept", "application/json");
            model = await httpClient.GetFromJsonAsync<UserProfileDTO>($"api/Profile/{userId}");
 
            isLoading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await LogToBrowserConsole($"Error loading: {ex.Message}");
        }

    }
    protected override async Task OnInitializedAsync()
    {
        await LoadUserProfile();
    }

    private async Task LogToBrowserConsole(string message) => await JSRuntime.InvokeVoidAsync("console.log", message);
}
